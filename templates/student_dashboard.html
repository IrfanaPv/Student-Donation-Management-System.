{% extends 'homepage.html' %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Dashboard</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

  <style>
    body {
      background: #f8f9fa;
      font-family: 'Inter', sans-serif;
    }
    .navbar-brand {
      font-weight: bold;
    }
    .profile-card {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .profile-pic {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
    }
    .stat-card {
      border-radius: 12px;
      transition: transform .15s ease, box-shadow .15s ease;
      cursor: pointer;
    }
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
    .active-stat {
      border: 2px solid #2563eb;
    }
    .table thead {
      background: #0d6efd;
      color: white;
    }
    .btn-request {
      border-radius: 8px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  {% if messages %}
  <div class="container mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Student Dashboard</a>
      <div class="d-flex">
        <a href="{% url 'logout_page' %}" class="btn btn-light btn-sm">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row mb-4 align-items-center">
      <!-- Left: Welcome -->
      <div class="col-md-8">
        <h3 class="mb-1">Welcome, {{ user.username }}</h3>
        <p class="text-muted mb-0">Here is your donation activity and profile overview.</p>
      </div>

      <!-- Right: Profile -->
      <div class="col-md-4">
        <div class="card profile-card p-3 text-center">
          <h5 class="fw-bold">{{ user.username }}</h5>
          <p class="text-muted mb-1"><i class="fas fa-envelope"></i> {{ data.email }}</p>
          <a href="{% url 'student_profile' %}" class="btn btn-sm btn-outline-primary mt-2">
            <i class="fas fa-user"></i> View Profile
          </a>
        </div>
      </div>
    </div>

    <!-- New Request Button -->
    <div class="d-flex justify-content-end mb-4">
      <a href="{% url 'help_request' %}" class="btn btn-success btn-request">
        <i class="fas fa-plus-circle"></i> New Request
      </a>
    </div>

    <!-- Stat Cards -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card shadow-sm stat-card text-center p-3" data-filter="all">
          <i class="fas fa-list fa-2x text-primary mb-2"></i>
          <h6>Total Requests</h6>
          <h4 id="count-total">0</h4>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm stat-card text-center p-3" data-filter="approved">
          <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
          <h6>Approved</h6>
          <h4 id="count-approved">0</h4>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm stat-card text-center p-3" data-filter="pending">
          <i class="fas fa-hourglass-half fa-2x text-warning mb-2"></i>
          <h6>Pending</h6>
          <h4 id="count-pending">0</h4>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm stat-card text-center p-3" data-filter="rejected">
          <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
          <h6>Rejected</h6>
          <h4 id="count-rejected">0</h4>
        </div>
      </div>
    </div>

    <!-- Requests Table -->
    <div id="requests-section" class="card shadow-sm border-0 rounded-3">
      <div class="card-header bg-white">
        <h5 class="mb-0"><i class="fas fa-hand-holding-heart"></i> My Requests</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Request Title</th>
                <th>Category</th>
                <th>Amount Needed</th>
                <th>ID Document</th>
                <th>Income Certificate</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for request in x %}
              <tr class="request-row" data-status="{{ request.status|lower }}">
                <td>{{ forloop.counter }}</td>
                <td>{{ request.description }}</td>
                <td>{{ request.catogery }}</td>
                <td>₹{{ request.amount_needed }}</td>
                <td>{{ request.id_document }}</td>
                <td>{{ request.income_certificate }}</td>
                <td>
                  {% if request.status == 'approved' %}
                    <span class="badge bg-success">Approved</span>
                  {% elif request.status == 'pending' %}
                    <span class="badge bg-warning text-dark">Pending</span>
                  {% else %}
                    <span class="badge bg-danger">Rejected</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" class="text-center text-muted">No requests yet.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const rows = Array.from(document.querySelectorAll('.request-row'));
      const statCards = Array.from(document.querySelectorAll('.stat-card'));

      function updateCounts() {
        const counts = { total: rows.length, approved:0, pending:0, rejected:0 };
        rows.forEach(r => {
          const s = (r.dataset.status || '').trim().toLowerCase();
          if (s === 'approved') counts.approved++;
          else if (s === 'pending') counts.pending++;
          else if (s === 'rejected') counts.rejected++;
        });
        document.getElementById('count-total').textContent = counts.total;
        document.getElementById('count-approved').textContent = counts.approved;
        document.getElementById('count-pending').textContent = counts.pending;
        document.getElementById('count-rejected').textContent = counts.rejected;
      }

      function filterRows(filter) {
        rows.forEach(r => {
          const s = (r.dataset.status || '').trim().toLowerCase();
          r.style.display = (filter === 'all' || s === filter) ? '' : 'none';
        });
      }

      statCards.forEach(card => {
        card.addEventListener('click', () => {
          const filter = card.dataset.filter;
          statCards.forEach(c => c.classList.remove('active-stat'));
          card.classList.add('active-stat');
          filterRows(filter);
          document.getElementById('requests-section').scrollIntoView({ behavior: 'smooth' });
        });
      });

      updateCounts();
      filterRows('all');
    });
  </script>
</body>
</html>
{% endblock %}
